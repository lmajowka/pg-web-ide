<div class="db-ide">
  <% if flash[:notice] %>
    <div class="db-ide__toast db-ide__toast--success" role="status"><%= flash[:notice] %></div>
  <% elsif flash[:alert] %>
    <div class="db-ide__toast db-ide__toast--error" role="alert"><%= flash[:alert] %></div>
  <% end %>

  <aside class="db-ide__sidebar">
    <header class="db-ide__brand">
      <div class="db-ide__logo" aria-hidden="true">DB</div>
      <div>
        <h1>Database IDE</h1>
        <p class="db-ide__env">Environment: <span><%= Rails.env %></span></p>
      </div>
    </header>

    <section class="db-ide__card">
      <header class="db-ide__card-header">
        <h2>Tables</h2>
        <p><%= pluralize(@tables.size, "table") %></p>
      </header>

      <%= form_with url: db_ide_path, method: :get, local: true, class: "db-ide__table-picker" do %>
        <label for="table-select" class="db-ide__label">Choose table</label>
        <select name="table" id="table-select" class="db-ide__select" onchange="this.form.submit()">
          <% @tables.each do |table| %>
            <option value="<%= table %>" <%= "selected" if table == @selected_table %>><%= table %></option>
          <% end %>
        </select>
        <noscript>
          <button type="submit" class="db-ide__button">Load</button>
        </noscript>
      <% end %>
    </section>
  </aside>

  <main class="db-ide__content" aria-live="polite">
    <section class="db-ide__panel" aria-labelledby="table-preview-heading">
      <header class="db-ide__panel-header">
        <div>
          <h2 id="table-preview-heading"><%= @selected_table || "No table selected" %></h2>
          <% if @table_result.present? %>
            <p class="db-ide__meta">
              Showing up to <strong><%= @table_result.rows.size %></strong> rows.
            </p>
          <% end %>
        </div>
        <div class="db-ide__panel-actions">
          <% if @selected_table.present? %>
            <% if @show_new_form %>
              <%= link_to "Close new record", db_ide_path(table: @selected_table), class: "db-ide__button db-ide__button--ghost" %>
            <% else %>
              <%= link_to "New record", db_ide_path(table: @selected_table, new: true), class: "db-ide__button" %>
            <% end %>
          <% end %>
          <%= link_to "Refresh", db_ide_path(table: @selected_table), class: "db-ide__button db-ide__button--ghost" %>
        </div>
      </header>

      <div class="db-ide__panel-body">
        <% if @table_result.present? %>
          <div class="db-ide__table-wrapper">
            <%= render partial: "table", locals: {
              result: @table_result,
              table_name: @selected_table,
              primary_key: @table_primary_key,
              columns_info: @table_columns_info,
              editable_row_id: @editable_row_id,
              editable_row: @editable_row
            } %>
          </div>
        <% else %>
          <div class="db-ide__empty">
            <p>No data available for this table.</p>
          </div>
        <% end %>
      </div>
    </section>

    <% if @show_new_form && @selected_table.present? %>
      <section class="db-ide__panel db-ide__panel--accent" aria-labelledby="new-row-heading">
        <header class="db-ide__panel-header">
          <div>
            <h2 id="new-row-heading">Create new record</h2>
            <p class="db-ide__meta">Table: <strong><%= @selected_table %></strong></p>
          </div>
        </header>

        <div class="db-ide__panel-body">
          <%= render partial: "edit_form", locals: {
            table_name: @selected_table,
            primary_key: @table_primary_key,
            columns_info: @table_columns_info,
            row: @new_row_template,
            form_url: db_ide_create_path,
            form_method: :post,
            submit_label: "Create record",
            allow_primary_input: true
          } %>
        </div>
      </section>
    <% end %>

    <% if @editable_row.present? && @selected_table.present? %>
      <section class="db-ide__panel" aria-labelledby="edit-row-heading">
        <header class="db-ide__panel-header">
          <div>
            <h2 id="edit-row-heading">Edit row</h2>
            <p class="db-ide__meta">Table: <strong><%= @selected_table %></strong> Â· Primary key: <strong><%= @table_primary_key %></strong></p>
          </div>
        </header>

        <div class="db-ide__panel-body">
          <%= render partial: "edit_form", locals: {
            table_name: @selected_table,
            primary_key: @table_primary_key,
            columns_info: @table_columns_info,
            row: @editable_row
          } %>
        </div>
      </section>
    <% end %>

    <section class="db-ide__panel" aria-labelledby="sql-runner-heading">
      <header class="db-ide__panel-header">
        <div>
          <h2 id="sql-runner-heading">SQL Runner</h2>
          <p class="db-ide__meta">Execute custom SQL against the development database.</p>
        </div>
      </header>

      <div class="db-ide__panel-body">
        <%= form_with url: db_ide_execute_path, method: :post, local: true, class: "db-ide__form", data: { turbo: false } do |form| %>
          <%= hidden_field_tag :table, @selected_table %>
          <label for="sql-query" class="db-ide__label">Query</label>
          <%= form.text_area :query, id: "sql-query", value: @query, rows: 8, class: "db-ide__textarea" %>
          <div class="db-ide__actions">
            <%= form.submit "Run query", class: "db-ide__button" %>
          </div>
        <% end %>

        <% if @query_error.present? %>
          <div class="db-ide__alert db-ide__alert--error" role="alert">
            <strong>Query failed:</strong>
            <pre><%= @query_error %></pre>
          </div>
        <% elsif @query_result.present? %>
          <div class="db-ide__result" aria-live="polite">
            <h3 class="db-ide__result-title">Result</h3>
            <div class="db-ide__table-wrapper">
              <%= render partial: "table", locals: { result: @query_result } %>
            </div>
          </div>
        <% end %>
      </div>
    </section>
  </main>
</div>
