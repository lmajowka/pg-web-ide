<div class="db-ide" data-controller="sidebar">
  <% if flash[:notice] %>
    <div class="db-ide__toast db-ide__toast--success" role="status"><%= flash[:notice] %></div>
  <% elsif flash[:alert] %>
    <div class="db-ide__toast db-ide__toast--error" role="alert"><%= flash[:alert] %></div>
  <% end %>

  <!-- Mobile Menu Button -->
  <button class="db-ide__menu-toggle"
          type="button"
          data-sidebar-target="toggle"
          data-action="click->sidebar#toggle"
          aria-label="Toggle navigation menu"
          aria-expanded="false">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-sidebar-target="iconMenu" aria-hidden="true">
      <path d="M3 12h18M3 6h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-sidebar-target="iconClose" style="display: none;" aria-hidden="true">
      <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>

  <!-- Sidebar Overlay (Mobile) -->
  <div class="db-ide__sidebar-overlay"
       data-sidebar-target="overlay"
       data-action="click->sidebar#close"></div>

  <!-- Sidebar -->
  <div class="db-ide__sidebar-wrapper" data-sidebar-target="drawer">
    <aside class="db-ide__sidebar">
      <header class="db-ide__brand">
        <div class="db-ide__logo" aria-hidden="true">PWI</div>
        <div>
          <h1>Postgres Web IDE</h1>
        </div>
      </header>

      <section class="db-ide__card">
        <header class="db-ide__card-header">
          <h2>Tables</h2>
          <p><%= pluralize(@tables.size, "table") %></p>
        </header>

        <ul class="db-ide__table-list">
          <% @tables.each do |table| %>
            <% active = table == @selected_table %>
            <li>
              <%= link_to table,
                          db_ide_path(table: table),
                          class: "db-ide__chip#{" db-ide__chip--active" if active}",
                          aria_current: (active ? "page" : nil),
                          data: { action: "click->sidebar#close" } %>
            </li>
          <% end %>
        </ul>
      </section>
    </aside>
  </div>

  <main class="db-ide__content" aria-live="polite">
    <% if @show_new_form && @selected_table.present? %>
      <section class="db-ide__panel db-ide__panel--accent" aria-labelledby="new-row-heading">
        <header class="db-ide__panel-header">
          <div>
            <h2 id="new-row-heading">Create new record</h2>
            <p class="db-ide__meta">Table: <strong><%= @selected_table %></strong></p>
          </div>
        </header>

        <div class="db-ide__panel-body">
          <%= render partial: "edit_form", locals: {
            table_name: @selected_table,
            primary_key: @table_primary_key,
            columns_info: @table_columns_info,
            row: @new_row_template,
            form_url: db_ide_create_path,
            form_method: :post,
            submit_label: "Create record",
            allow_primary_input: true
          } %>
        </div>
      </section>
    <% end %>

    <% if @editable_row.present? && @selected_table.present? %>
      <section class="db-ide__panel" aria-labelledby="edit-row-heading">
        <header class="db-ide__panel-header">
          <div>
            <h2 id="edit-row-heading">Edit row</h2>
            <p class="db-ide__meta">Table: <strong><%= @selected_table %></strong> Â· Primary key: <strong><%= @table_primary_key %></strong></p>
          </div>
        </header>

        <div class="db-ide__panel-body">
          <%= render partial: "edit_form", locals: {
            table_name: @selected_table,
            primary_key: @table_primary_key,
            columns_info: @table_columns_info,
            row: @editable_row
          } %>
        </div>
      </section>
    <% end %>

    <section class="db-ide__panel" aria-labelledby="table-preview-heading" data-controller="table-view">
      <header class="db-ide__panel-header">
        <div>
          <h2 id="table-preview-heading"><%= @selected_table || "No table selected" %></h2>
          <% if @table_result.present? %>
            <p class="db-ide__meta">
              Showing up to <strong><%= @table_result.rows.size %></strong> rows.
            </p>
          <% end %>
        </div>
        <div class="db-ide__panel-actions">
          <% if @table_result.present? %>
            <!-- View Toggle (Mobile) -->
            <div class="db-ide__view-toggle" role="group" aria-label="View mode">
              <button type="button"
                      class="db-ide__view-toggle-btn is-active"
                      data-table-view-target="tableBtn"
                      data-action="click->table-view#showTable"
                      aria-label="Table view"
                      aria-pressed="true">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M3 3h18v18H3V3z" stroke="currentColor" stroke-width="2"/>
                  <path d="M3 9h18M3 15h18M9 3v18M15 3v18" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
              <button type="button"
                      class="db-ide__view-toggle-btn"
                      data-table-view-target="cardBtn"
                      data-action="click->table-view#showCards"
                      aria-label="Card view"
                      aria-pressed="false">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <rect x="3" y="3" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
                  <rect x="14" y="3" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
                  <rect x="3" y="14" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
                  <rect x="14" y="14" width="7" height="7" rx="1" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </div>
          <% end %>
          <% if @selected_table.present? %>
            <% if @show_new_form %>
              <%= link_to "Close new record", db_ide_path(table: @selected_table), class: "db-ide__button db-ide__button--ghost" %>
            <% else %>
              <%= link_to "New record", db_ide_path(table: @selected_table, new: true), class: "db-ide__button" %>
            <% end %>
          <% end %>
          <%= link_to "Refresh", db_ide_path(table: @selected_table), class: "db-ide__button db-ide__button--ghost" %>
          <%= link_to "SQL Runner", db_ide_sql_runner_path, class: "db-ide__button db-ide__button--ghost" %>
        </div>
      </header>

      <div class="db-ide__panel-body">
        <% if @table_result.present? %>
          <%# Table Filters %>
          <div class="db-ide__filters" data-controller="table-filter" 
               data-table-filter-columns-value="<%= @table_result.columns.to_json %>"
               data-table-filter-table-value="<%= @selected_table %>">
            <div class="db-ide__filters-header">
              <div class="db-ide__filters-title">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 4h18M7 8h10M5 12h14M8 16h8M6 20h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Filters
              </div>
              <div class="db-ide__filters-actions">
                <button type="button" class="db-ide__add-filter-btn" 
                        data-action="click->table-filter#addFilter"
                        aria-label="Add filter">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  Add Filter
                </button>
                <button type="button" class="db-ide__apply-filters-btn" 
                        data-action="click->table-filter#applyFilters"
                        aria-label="Apply filters">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Apply Filters
                </button>
              </div>
            </div>
            
            <div class="db-ide__filters-list" data-table-filter-target="filtersContainer">
              <%# Filters will be dynamically added here %>
            </div>
          </div>

          <% if @table_result.rows.empty? %>
            <%# Check if there are filters applied %>
            <% has_filters = params.keys.any? { |k| k.start_with?('filter_') } %>
            <% if has_filters %>
              <div class="db-ide__no-results">
                <div class="no-results-icon">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </div>
                <h3>No results found</h3>
                <p>Your filters didn't match any records. Try adjusting your filters or clear them to see all data.</p>
                <%= link_to "Clear all filters", db_ide_path(table: @selected_table), class: "db-ide__button db-ide__button--ghost" %>
              </div>
            <% else %>
              <div class="db-ide__empty">
                <p>This table appears to be empty.</p>
              </div>
            <% end %>
          <% else %>
            <div class="db-ide__table-wrapper" data-table-view-target="wrapper" data-view="table" data-table-filter-target="tableWrapper">
              <%= render partial: "table", locals: {
                result: @table_result,
                table_name: @selected_table,
                primary_key: @table_primary_key,
                columns_info: @table_columns_info,
                editable_row_id: @editable_row_id,
                editable_row: @editable_row,
                sort_column: @sort_column,
                sort_direction: @sort_direction
              } %>
            </div>
          <% end %>
        <% else %>
          <div class="db-ide__empty">
            <p>No data available for this table.</p>
          </div>
        <% end %>
      </div>
    </section>
  </main>
</div>
