<% unless result.is_a?(ActiveRecord::Result) %>
  <pre><%= result.inspect %></pre>
  <% return %>
<% end %>

<% editable = defined?(table_name) && primary_key.present? %>

<table class="db-ide__table">
  <thead>
    <tr>
      <% if editable %>
        <th class="db-ide__table-header db-ide__table-header--actions">Actions</th>
      <% end %>
      <% result.columns.each do |column| %>
        <th><%= column %></th>
      <% end %>
    </tr>
  </thead>
  <tbody>
    <% result.rows.each do |row_values| %>
      <% row_hash = result.columns.zip(row_values).to_h %>
      <% row_id = editable ? row_hash[primary_key] : nil %>
      <% is_editing = editable && editable_row_id.present? && row_id.present? && row_id.to_s == editable_row_id.to_s %>

      <tr class="<%= "db-ide__row--active" if is_editing %>">
        <% if editable %>
          <td class="db-ide__cell db-ide__cell--actions">
            <% if row_id.present? %>
              <div class="db-ide__action-stack">
                <% if is_editing %>
                  <span class="db-ide__chip db-ide__chip--active">Editing</span>
                  <%= link_to "Cancel", db_ide_path(table: table_name), class: "db-ide__button db-ide__button--ghost db-ide__button--sm" %>
                <% else %>
                  <%= link_to "Edit", db_ide_path(table: table_name, edit: row_id), class: "db-ide__chip" %>
                <% end %>

                <%= button_to "Delete", db_ide_destroy_path,
                              method: :delete,
                              params: { table: table_name, id: row_id },
                              class: "db-ide__button db-ide__button--danger db-ide__button--sm",
                              form: { class: "db-ide__inline-form", data: { turbo_confirm: "Delete this row? This action cannot be undone." } } %>
              </div>
            <% else %>
              <span class="db-ide__cell-muted">—</span>
            <% end %>
          </td>
        <% end %>

        <% result.columns.each do |column| %>
          <% value = row_hash[column] %>
          <% display_value = case value
                            when Time, ActiveSupport::TimeWithZone
                              value.utc.strftime("%Y-%m-%d %H:%M:%S UTC")
                            else
                              value
                            end %>
          <td class="db-ide__cell">
            <%= display_value.presence || "—" %>
          </td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<p class="db-ide__table-meta">Rows: <%= result.rows.size %></p>
