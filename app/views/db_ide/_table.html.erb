<% unless result.is_a?(ActiveRecord::Result) %>
  <pre><%= result.inspect %></pre>
  <% return %>
<% end %>

<% editable = defined?(table_name) && primary_key.present? %>

<table class="db-ide__table">
  <thead>
    <tr>
      <% if editable %>
        <th class="db-ide__table-header db-ide__table-header--actions">Actions</th>
      <% end %>
      <% result.columns.each do |column| %>
        <% 
          is_sorted = defined?(sort_column) && sort_column == column
          is_desc = defined?(sort_direction) && sort_direction == "desc"
          next_direction = is_sorted && !is_desc ? "desc" : "asc"
          sort_params = { table: table_name, sort: column, direction: next_direction }
          sort_params[:edit] = editable_row_id if defined?(editable_row_id) && editable_row_id.present?
        %>
        <th class="db-ide__table-header <%= "db-ide__table-header--sortable" if defined?(table_name) %> <%= "db-ide__table-header--sorted" if is_sorted %>">
          <% if defined?(table_name) %>
            <%= link_to db_ide_path(sort_params), class: "db-ide__sort-link" do %>
              <span><%= column %></span>
              <% if is_sorted %>
                <svg class="db-ide__sort-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <% if is_desc %>
                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <% else %>
                    <path d="M7 14l5-5 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <% end %>
                </svg>
              <% else %>
                <svg class="db-ide__sort-icon db-ide__sort-icon--inactive" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M7 10l5-5 5 5M7 14l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              <% end %>
            <% end %>
          <% else %>
            <%= column %>
          <% end %>
        </th>
      <% end %>
    </tr>
  </thead>
  <tbody>
    <% result.rows.each do |row_values| %>
      <% row_hash = result.columns.zip(row_values).to_h %>
      <% row_id = editable ? row_hash[primary_key] : nil %>
      <% is_editing = editable && editable_row_id.present? && row_id.present? && row_id.to_s == editable_row_id.to_s %>

      <tr class="<%= "db-ide__row--active" if is_editing %>">
        <% if editable %>
          <td class="db-ide__cell db-ide__cell--actions">
            <% if row_id.present? %>
              <div class="db-ide__action-stack">
                <% if is_editing %>
                  <span class="db-ide__chip db-ide__chip--active">Editing</span>
                  <%= link_to db_ide_path(table: table_name), class: "db-ide__button db-ide__button--ghost db-ide__button--icon" do %>
                    <span class="db-ide__sr-only">Cancel</span>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                      <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  <% end %>
                <% else %>
                  <%= link_to db_ide_path(table: table_name, edit: row_id), class: "db-ide__button db-ide__button--ghost db-ide__button--icon" do %>
                    <span class="db-ide__sr-only">Edit</span>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                      <path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      <path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  <% end %>
                <% end %>

                <%= button_to db_ide_destroy_path,
                              method: :delete,
                              params: { table: table_name, id: row_id },
                              class: "db-ide__button db-ide__button--danger db-ide__button--icon",
                              form: { class: "db-ide__inline-form", data: { turbo_confirm: "Delete this row? This action cannot be undone." } } do %>
                  <span class="db-ide__sr-only">Delete</span>
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                <% end %>
              </div>
            <% else %>
              <span class="db-ide__cell-muted">—</span>
            <% end %>
          </td>
        <% end %>

        <% result.columns.each do |column| %>
          <% value = row_hash[column] %>
          <% display_value = case value
                            when Time, ActiveSupport::TimeWithZone
                              value.utc.strftime("%Y-%m-%d %H:%M:%S UTC")
                            else
                              value
                            end %>
          <td class="db-ide__cell">
            <%= display_value.presence || "—" %>
          </td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<p class="db-ide__table-meta">Rows: <%= result.rows.size %></p>
